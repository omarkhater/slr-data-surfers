import netCDF4
import pandas as pd
import numpy as np

def netCDF_2_pd(path):
    f = netCDF4.Dataset(path)
    latitude = f.variables['latitude'][:]
    longitude = f.variables['longitude'][:]
    time = f.variables['time'][:]  # This is likely in a numeric format representing dates

    # Convert numeric time to datetime
    # This depends on the 'units' and 'calendar' attributes of the time variable
    time_units = f.variables['time'].units
    time_calendar = f.variables['time'].calendar if hasattr(f.variables['time'], 'calendar') else 'standard'
    time_datetimes = netCDF4.num2date(time, units=time_units, calendar=time_calendar)
    time_units = f.variables['time'].units
    try:
        calendar = f.variables['time'].calendar
    except AttributeError:  # In case the 'calendar' attribute is missing
        calendar = 'gregorian'  # or 'standard', choose a default


    # Convert your numeric time values to numpy.datetime64 objects
    converted_times = convert_numeric_time_to_datetime64(time, time_units, calendar)

    # Since your dataset likely represents a 2D grid of points over multiple times, 
    # we'll need to repeat the time array to match the number of latitude and longitude points
    time_repeated = np.repeat(converted_times, latitude.size * longitude.size)

    # Create a meshgrid for latitude and longitude, then flatten them for the DataFrame
    lon, lat = np.meshgrid(longitude, latitude)
    lon_flat = lon.flatten()
    lat_flat = lat.flatten()

    # Repeat latitude and longitude coordinates for each time step
    lat_repeated = np.tile(lat_flat, len(time_datetimes))
    lon_repeated = np.tile(lon_flat, len(time_datetimes))

    adt = f.variables['adt'][:]
    adt_flat = adt.flatten().data  # Or another method to match DataFrame's structure

    # Now combine everything into a DataFrame
    df = pd.DataFrame({
        'Time': time_repeated,
        'Latitude': lat_repeated,
        'Longitude': lon_repeated, 
        'adt': adt_flat,
    })
    return df


def PP_df(df, start_day, end_day, n_days=1):
    """
    Process a DataFrame to select data between start and end days, calculate the rate of change in 'adt'
    values over a specified number of days, and return a row entry every n days.
    
    Parameters:
    - df: DataFrame containing the data.
    - start_day: The start day for selecting the data in YYYY-MM-DD format.
    - end_day: The end day for selecting the data in YYYY-MM-DD format.
    - n_days: The number of days over which to calculate the difference in 'adt' values. Defaults to 1.
    
    Returns:
    - A DataFrame with the rate of change calculated over the specified number of days, with an entry every n days.
    """
    start_day = pd.to_datetime(start_day)
    end_day = pd.to_datetime(end_day)
    # Filter out land data and select data between start_day and end_day
    sea_df = df[(df['adt'] > -2.147484e+07) & (df['Time'] >= start_day) & (df['Time'] <= end_day)]
    sea_df['Time'] = pd.to_datetime(sea_df['Time'])
    sea_df.sort_values(by=['Latitude', 'Longitude', 'Time'], inplace=True)
    
    # Calculate the difference in 'adt' values over n_days
    sea_df['Rate_of_Change'] = sea_df.groupby(['Latitude', 'Longitude'])['adt'].diff(periods=n_days)
    
    # Instead of dropping NaNs, filter to include every n-th day's data
    # This is achieved by resetting the index within each group and then filtering
    sea_df = sea_df.groupby(['Latitude', 'Longitude']).apply(lambda x: x.iloc[n_days-1::n_days]).reset_index(drop=True)
    sea_df.fillna(0, inplace=True)
    return sea_df

def convert_numeric_time_to_datetime64(time, units, calendar):
    # Use netCDF4.num2date to convert numeric time values to datetime objects
    cftime_objs = netCDF4.num2date(time, units=units, calendar=calendar)
    
    # Convert cftime objects to numpy.datetime64 objects
    datetime64_objs = np.array([np.datetime64(date) for date in cftime_objs])
    
    return datetime64_objs

def get_state_data(year):
    
    state_dic = {"2021": {"AL": 0.5429423272272488, "GA": 0.6464300955040011, "FL": 1.4747096486917715, "TN": 1.1372408123014286, "TX": 0.7438972239014163, "MS": -0.1275535281693059, "NC": 0.9502403547211243, "CA": -1.031155851087727, "VA": -0.1434072014560221, "CO": 0.00909401623406284, "SC": 1.576771789789334, "LA": -0.8366090025428874, "OH": -0.10311575343652278, "IL": -1.0200873483363122, "NY": -1.6504318162273244, "MI": -0.09092400963065513, "KY": 0.1604838917813008, "IN": 0.17034136560067467, "WA": -0.12603563816972338, "MO": 0.1916789372309149, "AZ": 1.0607806534836997, "PA": -0.1472046220534838, "MD": -0.5070220723635699, "AR": 0.6606153435700027, "OK": 0.6825491919492434, "KS": -0.20894490777392302, "NV": 0.7899887616117663, "MA": -0.8088850219906317, "WI": -0.020883934770444465, "UT": 0.5012592405869196, "IA": -0.044364342864929775, "NJ": -0.3385846919956289, "MN": -0.34937678268808375, "OR": -0.2024680462740632, "NM": -0.1679265601177085, "HI": -0.8820134713776292, "AK": -0.7110122918708773, "WV": 0.1375928764280454, "CT": 0.0011011508149639654, "ID": 2.038918185187335, "NE": -0.2522221797879351, "ME": 1.189144711044833, "MT": 1.6491070761413735, "SD": 0.8194497539800965, "ND": -0.9826061473219673, "WY": 0.4310578392379136, "NH": 0.8526251419585918, "DE": 1.3548346823695874, "VT": 0.5556444510674994, "RI": -0.09318728997277793}, "2020": {"AL": 0.4270483282334644, "GA": 0.43458160563391257, "FL": 0.939400759028851, "TN": 0.8090964169266702, "TX": 0.5578153921246386, "MS": -0.1995729364398429, "NC": 0.8331212428113453, "CA": -0.7894147144539396, "VA": -0.1531994039068931, "CO": 0.2967989888119561, "LA": -0.596852245222073, "SC": 1.3024260192852337, "OH": -0.10698426693171972, "NY": -1.4969072776040664, "MI": -0.11146733553535487, "KY": 0.13561288009127206, "IL": -0.9366279394197677, "IN": 0.11511595867472013, "WA": 0.20261150516007218, "AZ": 1.4400136655203024, "PA": -0.04899502531502155, "MO": 0.15860364396634682, "MD": -0.40507749401102033, "AR": 0.38930135887158074, "OK": 0.46099902460884323, "KS": -0.2909982918367707, "NJ": -0.30711434272972293, "NV": 1.1417796732193375, "OR": 0.4053811465923567, "WI": 0.00023797505439713117, "MA": -0.6539517323245514, "HI": -0.7075116824798551, "UT": 0.5818193926250157, "AK": -1.0829281921141916, "MN": -0.2366663156718471, "NM": 0.13321895789057778, "IA": -0.1439629238797597, "WV": -0.042223779274349366, "CT": -0.1244141356510051, "NE": -0.25735292665382337, "ID": 2.290255690484209, "MT": 1.2963339106799272, "ME": 1.0378913076232248, "WY": 0.23556816704593053, "ND": -0.8136737483309764, "NH": 0.8296114588775306, "DE": 1.2398147845152, "SD": 0.3018172575930868, "RI": 0.02795511626320072, "VT": 0.5472511376052059}, "2019": {"AL": 0.2020393943996795, "GA": 0.41630606961859, "FL": 0.7103749980865373, "TN": 0.6387206808903165, "TX": 0.4704904301547558, "MS": -0.3746577904106515, "NC": 0.5790625656510708, "CA": -0.5074450554033463, "VA": -0.12678910805105145, "LA": -0.5525227130075954, "SC": 1.0292847554568372, "CO": 0.4726404733672025, "OH": -0.14883515528293179, "NY": -0.9158989954344948, "MI": -0.20875004098763814, "IL": -0.7764613373774687, "WA": 0.5023734106357078, "KY": -0.05830441698413327, "AZ": 1.2487318403788423, "IN": 0.03230316227648315, "MO": -0.018953403942717086, "PA": -0.14240841724804382, "MD": -0.3697434954298988, "AR": 0.07141912366466094, "OK": 0.1109941074785353, "KS": -0.4655502233623778, "MA": -0.47460610120199054, "NV": 1.3147323274690739, "WI": -0.05606494095149793, "NJ": -0.38053727457883046, "OR": 0.5044483568794641, "HI": -0.7455745345009247, "MN": -0.10753234833006083, "UT": 0.24818334264952485, "NM": 0.0016015960109582018, "AK": -1.1965931060909551, "IA": -0.2401322212649435, "NE": -0.3193314312381229, "CT": -0.4559966730989687, "WV": -0.3969784016257396, "MT": 0.6124919174013506, "ID": 1.5371413422138296, "ND": -0.4445838046070977, "ME": 0.4795740211945807, "WY": 0.06430763690418974, "DE": 0.7979839352136481, "SD": 0.03350763805723069, "NH": 0.38954835466123117, "RI": -0.24258268211876313, "VT": -0.2645010319502359}, "2018": {"AL": 0.18560358000436586, "GA": 0.4304439900656, "FL": 0.6543868943807084, "TN": 0.6081034536000437, "TX": 0.3276559624485808, "MS": -0.31130877502538506, "NC": 0.6963782166271955, "CA": -0.4517536496619888, "VA": -0.14567544970649493, "LA": -0.5706329893212819, "SC": 1.0923979670371957, "CO": 0.6374745379934796, "NY": -0.9563785873940331, "OH": -0.10484992615754282, "IL": -0.8084684891790033, "KY": -0.01138172368493749, "MI": -0.12870114417363698, "WA": 0.5267251729877983, "IN": 0.0747443248860824, "AZ": 1.2404811576923553, "MO": -0.0415152960179855, "MD": -0.3486280949029927, "PA": -0.13261613983594117, "AR": 0.09552777526126623, "OK": -0.024116346355326154, "KS": -0.44564943218704817, "NJ": -0.4578461158025077, "WI": -0.01790350613681229, "MA": -0.49323309312078745, "NV": 1.544086243807959, "OR": 0.6152410709889848, "HI": -0.7775028450889367, "MN": 0.05792587177052883, "AK": -1.4281881343866505, "UT": 0.2987761244679203, "IA": -0.13288404900849132, "NM": -0.1401225702881835, "CT": -0.5465263469125651, "WV": -0.3405291306266056, "NE": -0.24609859078145355, "ID": 1.5187025494300956, "MT": 0.40250132381614107, "ND": -0.5982779476238842, "ME": 0.5459889786748177, "DE": 0.8774864433274205, "WY": -0.35781168203871705, "NH": 0.35493610310389945, "SD": 0.06257185498325465, "RI": -0.24139064928853285, "VT": -0.14632162359243653}, "2017": {"AL": 0.30194299714451855, "GA": 0.6009308745307276, "FL": 1.1467664396140043, "TN": 0.847118690699349, "TX": 0.417479155544067, "MS": -0.31271542398369684, "NC": 0.9658627300005652, "CA": -0.5016189348635434, "VA": -0.22101594254885087, "LA": -0.7852292380729394, "SC": 1.6468783785093237, "CO": 0.8325939247580105, "OH": -0.14897107826662032, "KY": -0.009164689864376154, "IL": -1.2007719049753367, "MI": -0.06861291886762493, "NY": -1.3424225982503093, "WA": 1.0198001294683485, "IN": 0.009817705092762858, "AZ": 1.4482487060995242, "MO": -0.019970633658696165, "PA": -0.2145532709986576, "MD": -0.49141616958135587, "AR": 0.21313968618809717, "OK": -0.3001303492364779, "KS": -0.6997022353599504, "MA": -0.6448483165657165, "HI": -1.371648371447411, "NJ": -0.6145524596947433, "NV": 1.795360207685733, "WI": -0.01859738321992314, "OR": 1.1275247440815548, "MN": 0.17670771209781203, "AK": -2.2185875027537505, "UT": 0.4481302631868983, "IA": -0.21492027444015047, "NM": -0.3947709060648625, "CT": -0.700088127252262, "NE": -0.35691168699799186, "WV": -0.6278706414198547, "ID": 2.191086650434608, "MT": 1.0341993989229104, "ME": 0.8994228120635198, "ND": -1.6330324082551326, "SD": 0.09952188546793535, "NH": 0.6645246666442373, "DE": 0.9389703053172315, "WY": -1.8201606244839752, "RI": -0.352976154549458, "VT": -0.044928514670474436}, "2016": {"AL": 0.019723610079899534, "GA": 0.4708626856941329, "FL": 1.1964048701303158, "TN": 0.5067644663429892, "TX": 0.230183742236911, "MS": -0.26751101537456956, "NC": 0.632515406067848, "CA": -0.22756306651620178, "LA": -0.30569276406446927, "VA": -0.2949949606183785, "CO": 0.858704970665617, "SC": 1.0393003300984207, "OH": -0.21955023382617248, "NY": -0.9184526574592881, "KY": -0.10137848200746565, "IL": -0.7597273338271515, "MI": -0.1678796402373763, "WA": 0.9397439782187772, "IN": -0.10543645186454956, "MO": -0.08661192978995615, "AZ": 0.9020192436604797, "PA": -0.3094987158488475, "MD": -0.42884190265405503, "AR": 0.037035636678022475, "KS": -0.6195215561549765, "OK": -0.12766343978098907, "NJ": -0.5986780032086557, "WI": -0.1526128280428361, "MA": -0.46858133265856117, "HI": -0.6471165104906343, "NV": 1.146726674565696, "OR": 1.206272868187425, "IA": -0.15977034255689126, "AK": -0.8703936303834118, "NM": -0.4520992409799381, "MN": -0.020942231767257312, "UT": 0.39274384948954205, "WV": -0.45402185876416035, "CT": -0.6677783452705112, "NE": -0.1218242420383997, "MT": 0.5719504627045677, "ND": -1.235517994067275, "ID": 1.0993572675822612, "ME": 0.26651413882695685, "WY": -0.7612260227543374, "RI": -0.3916972893094045, "SD": 0.0951137466111761, "NH": 0.27303159593373677, "DE": 0.4550146223980733, "VT": -0.33037281310579414}, "2015": {"AL": -0.09279261826581993, "GA": 0.2283034971421792, "FL": 0.7383895020917834, "TX": 0.2536452925928567, "TN": 0.2724446073861618, "MS": -0.2773416243799574, "CA": -0.10704438671464186, "NC": 0.23854441764124046, "LA": -0.11805127068261667, "VA": -0.15001916971443585, "SC": 0.5291061286766302, "CO": 0.6794900537811523, "NY": -0.5002084822923755, "OH": -0.16241077199413873, "IL": -0.44555598377823014, "MI": -0.2086965127198413, "KY": -0.12059204171330144, "WA": 0.502415375151913, "IN": -0.10352744065053394, "MO": -0.14038620297456347, "MD": -0.314915285626643, "PA": -0.1687695210311861, "AZ": 0.36938232684367145, "OK": 0.0353397521335035, "AR": -0.06935022764444591, "KS": -0.28232713631183287, "NJ": -0.44523537808046065, "MA": -0.20158761962282865, "HI": -0.11401924595347047, "NV": 0.8562731554368539, "WI": -0.16264492878364809, "MN": -0.10018503065807756, "OR": 0.521344934871826, "IA": -0.08377478854622818, "AK": -0.5044503586147747, "NM": -0.4220912647532629, "UT": 0.0487287311816046, "NE": -0.10271168052143353, "CT": -0.4332115585435266, "WV": -0.2516878707368546, "ND": 0.8496461553773381, "WY": -0.0017390048076794452, "ME": -0.11291139995230147, "MT": 0.2248308810054399, "ID": 0.1915995038570606, "NH": 0.01916304392505455, "RI": -0.3547365976609604, "DE": 0.28514672717948, "SD": 0.014303933674043805, "VT": -0.19597142594352637}, "2014": {"AL": -0.1303831167233728, "GA": 0.1529433652256963, "FL": 0.7387399120368703, "TX": 1.0542414344679718, "TN": 0.31211606579402074, "MS": -0.3726188518397022, "CA": -0.13806605529476268, "NC": 0.2623781026547087, "LA": -0.21631864451579766, "VA": -0.4408355513176743, "SC": 0.7643536305906764, "OH": -0.2017037272781266, "NY": -0.713721301205721, "CO": 0.7073674767023186, "KY": -0.2256391391453672, "MI": -0.29951088389589453, "IL": -0.7091461250571467, "IN": -0.11854849000786523, "MO": -0.16860482291409756, "WA": 0.48296981373150094, "PA": -0.2593219821664953, "MD": -0.07163040468981398, "AZ": 0.4262223146182165, "AR": -0.1853253217909399, "OK": 0.08404752246354888, "KS": -0.4651473112319773, "HI": -0.3882403027805661, "WI": -0.2142046858859392, "NV": 0.7136187923844522, "NJ": -0.5703371593199262, "MA": -0.3150796244711442, "OR": 0.6538155574726303, "AK": -1.23261002944592, "MN": -0.17686504634172748, "NM": -0.5746246497977058, "IA": -0.1267056730449217, "UT": -0.09557138533078179, "CT": -0.5522591608122299, "NE": -0.18182295317965233, "WV": -0.27882449732040315, "ND": 0.8595186273059611, "MT": 0.3058519729888386, "ID": 0.42523848413325754, "NH": 0.08135327918935062, "WY": -0.3307367085103661, "DE": 0.2704688620870294, "ME": 0.14230403163954575, "SD": -0.053151713317986536, "RI": -0.41800620972296204, "VT": -0.24014253621504378}, "2013": {"AL": -0.029650578002406495, "GA": -0.11704720568940546, "FL": -0.4988904154768396, "TX": -0.8096258787240642, "TN": -0.3003299889113038, "MS": 0.3253531402559261, "NC": -0.41358686436606057, "CA": 0.1534533790444692, "LA": 0.10278291749985481, "VA": 0.049151379712247256, "SC": -0.857841228084879, "OH": 0.19052148835110277, "NY": 0.767801568539574, "CO": -0.7824391667882983, "MI": 0.22928182051907237, "IL": 0.6770692905416755, "KY": 0.11035525772817528, "MO": 0.07145703063667246, "IN": 0.027508361093964085, "WA": -0.3660235817355904, "PA": 0.2577444814844692, "MD": 0.23986076418450078, "AZ": -0.3753289191640762, "OK": -0.31706877662320493, "AR": 0.08739126503653391, "KS": 0.4202297995396012, "NJ": 0.553265102239856, "WI": 0.17996148508166696, "HI": 0.03394159923581488, "NV": -0.6408644140185326, "MA": 0.26456047595848403, "MN": 0.12759828158026093, "AK": 1.3911330540594453, "IA": 0.019708405061677522, "NM": 0.5773306625784721, "OR": -0.4055276685164708, "UT": 0.06717485636771844, "CT": 0.6080011827839541, "WV": 0.17080199835784984, "NE": 0.11350831575782751, "MT": -0.588563079447679, "WY": 0.013667234382556404, "ID": -0.5307874898449165, "ND": -1.6447242939535522, "NH": -0.21248229837741933, "SD": -0.29861173012381864, "ME": -0.10779660025083823, "DE": -0.6242594419954967, "RI": 0.3924295158953521, "VT": 0.22014098024290962}, "2012": {"AL": 0.11171711284122292, "GA": -0.0128539298400677, "FL": -0.2197239199954586, "TN": -0.42159670955227385, "TX": -0.6473542561626231, "MS": 0.23365970505823228, "CA": 0.07397738977410624, "NC": -0.40138460704928985, "LA": 0.005143364013084884, "VA": -0.0693718736579185, "SC": -0.619056697266642, "IL": 0.5288109948304123, "MI": 0.27325006552146086, "OH": 0.2874738624408944, "NY": 0.7000306667280539, "KY": 0.06003286480024064, "CO": -0.6038666492658099, "WA": -0.22314633554206018, "IN": 0.14024410203744392, "MO": 0.1955691611831806, "PA": 0.18757330519978216, "AZ": -0.40927892539226096, "MD": 0.1098116266078713, "AR": 0.07711809047831361, "OK": -0.22823940721448843, "KS": 0.31860935883752384, "NV": -0.6402652715784629, "MA": 0.26923603443287586, "WI": 0.1657812844533674, "NJ": 0.5491386875671422, "MN": 0.16793017726033013, "OR": -0.23446427821530316, "HI": -0.04777237778546817, "IA": 0.10160182323800424, "AK": 0.6289042767228464, "NM": 0.5276527830115488, "UT": 0.16977284405907025, "NE": 0.08810564558835197, "WV": 0.0509377689053672, "CT": 0.5048532877045562, "WY": -0.8713382722762184, "ID": -0.026970023360715797, "SD": -0.5868926948985481, "NH": 0.023302775919627407, "MT": -0.3575595221872409, "ND": -1.8025910520595125, "ME": -0.0154374052968189, "DE": -0.21401844703401565, "RI": 0.5631527263558793, "VT": 0.3034530499871855}}
    yf = f"{year}"
    if yf in state_dic:
        state_data = state_dic[yf]
        return state_data
    else:
        print(f"state data for year {year} is not available. Available years only are: \n {list(state_dic.keys())}") 
        return {}
    
